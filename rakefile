# wxRuby rakefile
# Copyright 2004-2008 by wxRuby development team
# Released under the MIT-style wxruby2 license

# Influential environment variables
# WXRUBY_RELEASE    : build a release version, stripped of debugging info
# WXRUBY_DEBUG      : build a debug version
# WXRUBY_VERSION    : set the version info (x.x.x) for this tree
# WXRUBY_NO_UNICODE : try and build an ANSI version
# WXRUBY_EXCLUDED   : exclude certian classes from being compiled, even if present

require "./rake/rakeutil"

# Determine or set version of wxRuby library
require './rake/rakeversion'

WXRUBY_ROOT = File.dirname(__FILE__)

SWIG_DIR = ENV['SWIGDIR'] || 'swig'

# THE BINARY LIBRARY TO BE COMPILED
DLL_LIB = "wxruby3.#{RbConfig::CONFIG["DLEXT"]}"
TARGET_LIB = File.join(File.join(WXRUBY_ROOT, 'lib'), DLL_LIB)

# FOR ENSURING SUITABLE SWIG VERSION IS AVAILABLE
SWIG_CMD = ENV['SWIG_CMD'] || "swig"

# Ruby 2.5 is the minimum version for wxRuby3
__rb_ver = RUBY_VERSION.split('.').collect {|v| v.to_i}
if (__rb_major = __rb_ver.shift) < 2 || (__rb_major == 2 && __rb_ver.shift < 5)
  raise "wxRuby3 requires Ruby >= 2.5.0"
end

# SWIG 3.0.0 is now the minimum version required for all versions of Ruby
SWIG_MINIMUM_VERSION = '3.0.0'

require './rake/rakeconfigure'

# SOURCE FILE GROUPS

# Pure-ruby lib files
ALL_RUBY_LIB_FILES = FileList[ 'lib/**/*.rb' ]

require "./rake/rakewx"

if $config.has_wxwidgets_xml?

  # Redcloth library is required to build the documentation, but not
  # required just to compile the lib.
  begin
    require "./rake/rakedocs"
  rescue LoadError # documentation tasks will not be available
  end

  # Rubygems library is required to build a gem, but not just to compile
  # the lib.
  begin
    require "./rake/rakepackage"
  rescue LoadError # package tasks will not be available
  end

  #############################
  # public tasks

  if Object.respond_to?(:create_release_tasks, true)
    create_release_tasks
  end

  desc "Create the binary Ruby library file"
  task :default => [enum_list, *all_default_targets]

  desc "Compile object files from SWIG-generated sources"
  task :compile => all_compile_targets

  desc "Force a compile of object files from C++ sources"
  task :recompile => [:clean, :compile]

  desc "Delete SWIG interfaces, C++ sources, library and object files"
  task :clean_all => [:clean, :clean_src, *all_clean_targets] do
    delete_files_in($config.interface_dir)
    force_rmdir($config.interface_dir)
    delete_files_in($config.common_dir)
    force_rmdir($config.common_dir)
    delete_files_in($config.classes_dir)
    delete_files_in($config.rake_deps_dir, '.*.rake')
    force_rmdir($config.rake_deps_dir)
    force_rmdir($config.src_gen_dir)
    force_rmdir($config.src_dir)
  end

  desc "Delete C++ source and header files generated by SWIG"
  task :clean_src do
    delete_files_in($config.src_dir, "*.cpp")
    delete_files_in($config.src_dir, "*.h")
    delete_files_in($config.src_gen_dir, "*")
  end

  desc "Delete compiled libraries and object files"
  task :clean do
    delete_files_in($config.rb_lib_dir, "*.so")
    delete_files_in($config.obj_dir)
    force_rmdir($config.obj_dir)
  end

  desc "Run a wxRuby app"
  task :run, [:app] do |t, args|
    Rake::Task[:default].invoke unless args.extras.include? ':nodep'
    $config.run args[:app]
  end

  desc "Debug a wxRuby app"
  task :debug, [:app]  do |t, args|
    Rake::Task[:default].invoke unless args.extras.include? ':nodep'
    $config.debug args[:app]
  end

  desc "Memory check a wxRuby app"
  task :memcheck, [:app]  do |t, args|
    Rake::Task[:default].invoke unless args.extras.include? ':nodep'
    $config.memcheck args[:app], gensup: args.extras.include?(':gensup')
  end

  desc "Run wxRuby tests"
  task :wxtest do |t,args|
    Rake::Task[:default].invoke unless args.extras.include? ':nodep'
    tests = args.extras - [':nodep']
    $config.test *tests
  end
else
  desc "Bootstrap the wxRuby3 build environment"
  task :bootstrap do
    $config.do_bootstrap
  end

  desc "Report need for bootstrap"
  task :default do
    STDERR.puts "The wxRuby3 'bootstrap' task needs to be run to set up the wxWidgets XML doxygen output!"
    exit(1)
  end
end
