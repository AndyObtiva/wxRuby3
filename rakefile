# wxRuby rakefile
# Copyright 2004-2008 by wxRuby development team
# Released under the MIT-style wxruby2 license

# Influential environment variables
# WXRUBY_RELEASE    : build a release version, stripped of debugging info
# WXRUBY_DEBUG      : build a debug version
# WXRUBY_VERSION    : set the version info (x.x.x) for this tree
# WXRUBY_NO_UNICODE : try and build an ANSI version
# WXRUBY_EXCLUDED   : exclude certian classes from being compiled, even if present

require "./rake/rakeutil"

# Determine or set version of wxRuby library
require './rake/rakeversion'

WXRUBY_ROOT = File.dirname(__FILE__)

SWIG_DIR = ENV['SWIGDIR'] || 'swig'

# STANDARD BUILD DIRECTORIES
CLASSES_DIR = File.join(WXRUBY_ROOT, SWIG_DIR, 'classes')

# THE BINARY LIBRARY TO BE COMPILED
DLL_LIB = "wxruby3.#{RbConfig::CONFIG["DLEXT"]}"
TARGET_LIB = File.join(File.join(WXRUBY_ROOT, 'lib'), DLL_LIB)

# FOR ENSURING SUITABLE SWIG VERSION IS AVAILABLE
SWIG_CMD = ENV['SWIG_CMD'] || "swig"

# Ruby 2.5 is the minimum version for wxRuby3
__rb_ver = RUBY_VERSION.split('.').collect {|v| v.to_i}
if (__rb_major = __rb_ver.shift) < 2 || (__rb_major == 2 && __rb_ver.shift < 5)
  raise "wxRuby3 requires Ruby >= 2.5.0"
end

# SWIG 3.0.0 is now the minimum version required for all versions of Ruby
SWIG_MINIMUM_VERSION = '3.0.0'

require './rake/rakeconfigure'

# SOURCE FILE GROUPS

# THE MAIN ENTRY POINT MODULE
MAIN_MODULE = 'wx'

# Pure-ruby lib files
ALL_RUBY_LIB_FILES = FileList[ 'lib/**/*.rb' ]

require "./rake/rakewx"

if $config.has_wxwidgets_xml?

  # Redcloth library is required to build the documentation, but not
  # required just to compile the lib.
  begin
    require "./rake/rakedocs"
  rescue LoadError # documentation tasks will not be available
  end

  # Rubygems library is required to build a gem, but not just to compile
  # the lib.
  begin
    require "./rake/rakepackage"
  rescue LoadError # package tasks will not be available
  end

end

#############################
# public tasks

if $config.has_wxwidgets_xml?
  if Object.respond_to?(:create_release_tasks, true)
    create_release_tasks
  end

  desc "Create the binary Ruby library file"
  task :default => TARGET_LIB

  desc "Compile object files from SWIG-generated sources"
  task :compile => all_obj_files

  desc "Force a compile of object files from C++ sources"
  task :recompile => [:clean, :compile]

  desc "Delete SWIG interfaces, C++ sources, library and object files"
  task :clean_all => [:clean, :clean_src] do
    delete_files_in($config.interface_dir)
    force_rmdir($config.interface_dir)
    delete_files_in($config.common_dir)
    force_rmdir($config.common_dir)
    delete_files_in($config.classes_dir)
    delete_files_in($config.inc_dir)
  end

  desc "Delete C++ source and header files generated by SWIG"
  task :clean_src do
    delete_files_in_with_ext($config.src_dir, "cpp")
    delete_files_in_with_ext($config.src_dir, "h")
  end

  desc "Delete compiled libraries and object files"
  task :clean do
    force_delete(TARGET_LIB)
    #force_delete(VERSION_FILE)
    delete_files_in($config.obj_dir)
    #force_rmdir($obj_dir)
  end

  MAKE_NUM_THREADS = 2
  desc "Experimental generation of Makefile so can use multiprocessors to compile faster!"
  task :rake_make => "Makefile" do
    sh "make -j #{MAKE_NUM_THREADS}"
  end
else
  desc "Bootstrap the wxRuby3 build environment"
  task :bootstrap do
    $config.do_bootstrap
  end

  desc "Report need for bootstrap"
  task :default do
    STDERR.puts "The wxRuby3 'bootstrap' task needs to be run to set up the wxWidgets XML doxygen output!"
    exit(1)
  end
end
